#!/bin/bash

function usage {
	printf "Usage: `basename $0` instance_number [instance_name]\n"
}

## for Node
#FLAVOR="m2.large"
#IMAGE="DB_Node_SS"
## for Client
FLAVOR="CAU-4-99"
IMAGE="DB_Client_SS"

NETID1="net-id=71af3db1-7293-45ee-9d8e-e32b883e578f --nic net-id=3b68ed07-3984-4014-86de-baed44e604be"	#ISC-EXT1 ISC-INT1
NETID2="net-id=3b68ed07-3984-4014-86de-baed44e604be"	#ISC-INT1
NETID3="net-id=c1addb82-1321-4fe8-82eb-6f67a1b64e28 --nic net-id=d48a7ae5-9804-4dd4-a0fc-b15e4cd48bf0 --nic net-id=f2d6724d-c62d-4097-885e-515e2dd9e6ce"	#ISC-EXT1 ISC-INT1

declare -a AZ=("zone1" "zone2" "zone3" "zone4")
N=$1
NAME=$2
OPT=$3
PREFIX="Node"
NAME=${NAME:-"myinstance"}
MAX_PUB_IP=3

function boot {
	az=$1
	flavor=$2
	image=$3
	netid=$4
	name=$5
	BOOT="nova boot --availability-zone $az --flavor $flavor --image $image --nic $netid --config-drive true $name"
	echo $BOOT
	[ "$OPT" != "-o" ] && $BOOT
}

if [ $N -eq 1 ]; then
	boot ${AZ[0]} $FLAVOR $IMAGE "$NETID3" $NAME
elif [ $N -gt 1 ]; then
	count=${#AZ[@]}
	prefix=${NAME:-$PREFIX}
	for (( i=1; i<$[N+1]; i++ )); do
		if [ $i -lt 10 ]; then
			name="${prefix}0$i"
		elif [ $i -lt 100 ]; then
			name="${prefix}$i"
		else
			printf "Invalid instance number $N\n"
			exit 1
		fi

		case "$prefix" in
			Node)
				if [ $i -le $MAX_PUB_IP ]; then
					netid=$NETID1
				else
					netid=$NETID2
				fi
				;;
			*)
				netid=$NETID1
		esac

		idx=$[(i-1)%count]
		az=${AZ[idx]}
		boot $az $FLAVOR $IMAGE "$netid" $name
	done
else
	printf "Invalid instance number $N\n"
	usage
	exit 1
fi
